FROM nvidia/cuda:10.1-devel-ubuntu18.04
#FROM nvidia/cuda:11.2.1-base-ubuntu20.04

WORKDIR /home/

ENV DEBIAN_FRONTEND noninteractive

RUN \
    apt-get update        && 	\
    apt-get install --yes    	\
        build-essential      	\
        libblas-dev 		\
	liblapack-dev		\	
	gfortran             	\
        wget		     	\
	pkg-config		\
	git			\
        vim              &&  	\
    apt-get clean all    &&  	\
    rm -rf /var/lib/apt/lists/*

#install mpich
ARG mpich=3.3
ARG mpich_prefix=mpich-$mpich

RUN \
    wget https://www.mpich.org/static/downloads/$mpich/$mpich_prefix.tar.gz && \
    tar xvzf $mpich_prefix.tar.gz                                           && \
    cd $mpich_prefix                                                        && \
    ./configure                                                             && \
    make -j 4                                                               && \
    make install                                                            && \
    make clean                                                              && \
    cd ..                                                                   && \
    rm -rf $mpich_prefix $mpich_prefix.tar.gz

#install miniconda
ENV installer=Miniconda3-py38_4.10.3-Linux-x86_64.sh

RUN wget https://repo.anaconda.com/miniconda/$installer && \
    /bin/bash $installer -b -p /opt/miniconda3          && \
    rm -rf $installer

ENV PATH=/opt/miniconda3/bin:$PATH

#install mpi4py
ARG mpi4py=3.0.3
ARG mpi4py_prefix=mpi4py-$mpi4py

RUN \
    wget https://bitbucket.org/mpi4py/mpi4py/downloads/$mpi4py_prefix.tar.gz && \
    tar xvzf $mpi4py_prefix.tar.gz                                           && \
    cd $mpi4py_prefix                                                        && \
    python setup.py build                                                    && \
    python setup.py install                                                  && \
    cd ..                                                                    && \
    rm -rf $mpi4py_prefix $mpi4py_prefix.tar.gz

RUN /sbin/ldconfig


#install the packages we need
#downgrade bokeh to fix blank dask dashboard
RUN /opt/miniconda3/bin/conda install \
    astropy \
    dask \
    dask-cuda \
    dask-cudf \
    cudf \
    cupy \
    pandas \
    pytables \
    numpy \
    ipykernel \
    matplotlib \
    pyarrow \
    zarr    \
    fastparquet \ 
    pymatgen \
    jupyterlab \
    #cudatoolkit=10.1 \ 
    -c rapidsai -c nvidia -c conda-forge -c defaults -y && \
    /opt/miniconda3/bin/conda install \
    dask-mpi --no-deps -c conda-forge   

RUN \
    git clone https://github.com/alex-rakowski/py4DSTEM.git && \
    cd py4DSTEM && \
    git checkout parallel_image && \
    #/opt/miniconda3/bin/conda install -c anaconda -c conda-forge cython h5py==2.10.0 numpy==1.19.5 scipy==1.5.2  && \
    #/opt/miniconda3/bin/conda install -c conda-forge scikit-learn==0.23.2 scikit-image==0.17.2 && \ 
    /opt/miniconda3/bin/python setup.py install && \
    /opt/miniconda3/bin/conda clean -a
RUN \
    /opt/miniconda3/bin/python -m pip install jupyter-server-proxy
